#!/bin/sh -l

. $HOME/.bashrc
. ${DIR_SPS35}/descr_SPS3.5.sh
. $DIR_TEMPL/load_cdo

set -euvx

# Inputs
yy=$1
st=$2
nrun=$3
datamm=$4
workdir=$5
var=$6
#freq=$7
version=$7
here=$8


# CurrentDir
cdir="/users_home/csp/`whoami`/SPS/CMCC-SPS_SKILL_SCORES/ANOM"

# Datadir
fc="${yy}${st}"  
if [ $var = "sst" ] ; then
   if [ $st = "02" ] || [ $st = "06" ] || [ $st = "12" ] ; then
      datadir="/data/products/C3S/CMCC-SPS3.5/daily/${fc}"
      varincr="day"
   else
      datadir="/work/csp/sp1/CESM/archive/C3S/${fc}"
      varincr="6hour"
   fi
elif [ $var = "u200" ] || [ $var = "u850" ] || [ $var = "u925" ] || [ $var = "v200" ] || [ $var = "v850" ] || [ $var = "v925" ] ; then
   if [ $st = "02" ] || [ $st = "06" ] || [ $st = "12" ] ; then
      datadir="/data/products/C3S/CMCC-SPS3.5/daily/${fc}"
      varincr="day"
   else 
      datadir="/work/csp/sp1/CESM/archive/C3S/${fc}"
      varincr="12hour"
   fi
else
   datadir="/work/csp/sp1/CESM/archive/C3S/${fc}"
fi

# Create Dirs
mkdir -p $datamm
[ -d $workdir ] && rm -rf $workdir
mkdir -p $workdir
cd $workdir

# Variables cases
case $var
in
	t2m)     varC3S=tas    ; option="-subc,273.15"       ; hour="00:00:00" ; incr="6hour";;
	sst)     varC3S=tso    ; option=""                   ; hour="00:00:00" ; incr=${varincr};;
	precip)  varC3S=lwepr  ; option="-mulc,1000"         ; hour="12:00:00" ; incr="day";;
	snwdpt)  varC3S=lwesnw ; option=""                   ; hour="12:00:00" ; incr="day";;
	sic)     varC3S=sic    ; option=""                   ; hour="12:00:00" ; incr="day";;
	mslp)    varC3S=psl    ; option="-divc,100"          ; hour="00:00:00" ; incr="6hour";;
	z500)    varC3S=zg     ; option="-sellevel,50000"    ; hour="00:00:00" ; incr="12hour";;
	t850)    varC3S=ta     ; option="-sellevel,85000"    ; hour="00:00:00" ; incr="12hour";;
	u925)    varC3S=ua     ; option="-sellevel,92500"    ; hour="00:00:00" ; incr=${varincr} ;;
	v925)    varC3S=va     ; option="-sellevel,92500"    ; hour="00:00:00" ; incr=${varincr} ;;
	u850)    varC3S=ua     ; option="-sellevel,85000"    ; hour="00:00:00" ; incr=${varincr} ;;
	v850)    varC3S=va     ; option="-sellevel,85000"    ; hour="00:00:00" ; incr=${varincr} ;;
	u200)    varC3S=ua     ; option="-sellevel,20000"    ; hour="00:00:00" ; incr=${varincr} ;;
	v200)    varC3S=va     ; option="-sellevel,20000"    ; hour="00:00:00" ; incr=${varincr} ;;
 ssh)     varC3S=zos        ; option=""               ; hour="12:00:00" ; incr="month" ;;
 thetaot) varC3S=thetaot300 ; option=""               ; hour="12:00:00" ; incr="month" ;;
 evap)    varC3S=lwee       ; option=""               ; hour="12:00:00" ; incr="day" ;;
 mrroa)   varC3S=mrroa      ; option=""               ; hour="12:00:00" ; incr="day" ;;
 mrlsl)   varC3S=mrlsl      ; option=""               ; hour="12:00:00" ; incr="day" ;;
esac

#CHECK if the files was already produced
if [[ ${varC3S} = "mrroa" ]] ; then
   flist=`ls -1 $datadir/*mrroab_*.nc | head -n $nrun` 
else
   flist=`ls -1 $datadir/*${varC3S}_*.nc | head -n $nrun` 
fi
for ff in $flist ; do
  
  pp=`basename $ff | cut -d '_' -f9 | cut -d '.' -f1 | cut -c2-3`
  ppp=`printf "%03d" $(( 10#${pp} ))`
	 sps="sps_${yy}${st}_${ppp}"
  finaloutput=${var}_SPS3.5_${sps}.nc
	 outputfile="${var}_${sps}.output.1.nc"  	#python_fst_output
	 intoutput="${var}_${sps}.output.2.nc"		#cdo intermediate output

#	if [ ! -f $datamm/$finaloutput ] ; then
		# GET Data
		#rsync -auv $datadir/*${varC3S}_*r${pp}i00p00.nc .
  
		#tfile=`ls -1 cmcc_CMCC-CM2-v${version}_*_S${yy}${st}0100_*_${varC3S}_r${pp}i00p00.nc`
		cd $datadir
  if [[ $varC3S = "mrroa" ]] ; then
		   tfile=`ls -1 cmcc_CMCC-CM2-v*_*_S${yy}${st}0100_*_mrroab_r${pp}i00p00.nc`
  else
		   tfile=`ls -1 cmcc_CMCC-CM2-v*_*_S${yy}${st}0100_*_${varC3S}_r${pp}i00p00.nc`
  fi
		cd -
		ppp=`printf "%03d" $(( 10#${pp} ))` 
		sps="sps_${yy}${st}_${ppp}"

		# declaring and final outputfile
		finalinputfile=${tfile}
		finaloutput=${var}_SPS3.5_${sps}.nc
  if [[ $varC3S = "mrroa" ]] ; then
     cdo add $datadir/cmcc_CMCC-CM2-v*_*_S${yy}${st}0100_*_mrroas_r${pp}i00p00.nc $datadir/cmcc_CMCC-CM2-v*_*_S${yy}${st}0100_*_mrroab_r${pp}i00p00.nc ${finalinputfile}
		   ncks -O -6 ${finalinputfile} ${finalinputfile}_tmp.nc
  else
		   ncks -O -6 $datadir/${finalinputfile} ${finalinputfile}_tmp.nc
  fi
		cdo settaxis,$yy-$st-01,$hour,$incr ${finalinputfile}_tmp.nc ${finalinputfile}_tmp2.nc
		cdo setreftime,$yy-$st-01,$hour ${finalinputfile}_tmp2.nc ${finalinputfile}_tmp3.nc
		#Decide to do mean or sum if precipitation
		case $varC3S
		 in
		 lweprsn)      stat="monsum" ;;
		 *)            stat="monmean" ;;
		esac
# 20220505 NEW for soil moisture
  if [[ $var = "mrlsl" ]] ; then
     export filein=${finalinputfile}_tmp3.nc
     export fileout=${outputfile}
     ncl $cdir/compute_swi.ncl
     if [[ $? -ne 0 ]] ; then
        body="Something wrong with soil moisture. Exiting $cdir/compute_swi.ncl"
        title="SPS3.5 verification ERROR"
        ${DIR_SPS35}/sendmail.sh -m $machine -e $mymail -M "$body" -t "$title"
        exit 1
     fi
  else
		   cdo $stat $option ${finalinputfile}_tmp3.nc ${outputfile}
  fi

		# set output of python in months
		cdo settunits,months ${outputfile} ${intoutput} 
		# set calendar to C3S standard
		cdo setcalendar,365_day ${intoutput} ${finaloutput} 
		# clean intermediate files
		rm ${finalinputfile}_tmp*.nc
		rm ${outputfile} && rm ${intoutput} 
	
		mv ${var}_SPS3.5_${sps}.nc $datamm
#	else
#		continue	
#	fi
	
done  #end loop on plist

touch $here/logs/capsule_${yy}${st}_${var}_DONE
