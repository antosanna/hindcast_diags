#!/bin/sh -l

. $HOME/.bashrc
. ${DIR_SPS35}/descr_SPS3.5.sh
. $DIR_TEMPL/load_cdo

set -euvx

# Inputs
yy=$1
st=$2
nrun=$3
datamm=$4
workdir=$5
var=$6
version=$7
here=$8
filetype=$9

# CurrentDir
cdir="/users_home/csp/`whoami`/SPS/CMCC-SPS_SKILL_SCORES/ANOM"

# Create Dirs
mkdir -p $datamm
[ -d $workdir ] && rm -rf $workdir
mkdir -p $workdir
cd $workdir

# Variables cases

fc="${yy}${st}"  
export datadir="/data/csp/sp1/archive/CESM/SPS3.5"


#CHECK if the files was already produced
flist=`ls -1 $datadir/sps3.5_${fc}_0??/ocn/hist/*${fc}01_${fc}??_${filetype}.zip.nc | head -n $nrun`
for ff in $flist ; do
  
        ppp=`basename $ff | cut -d '_' -f3`  # | cut -d '.' -f1 | cut -c2-3`

	finaloutput=${var}_SPS3.5_sps_${yy}${st}_${ppp}
	if [ ! -f $datamm/$finaloutput.nc ] ; then
  
		sps="sps3.5_${yy}${st}_${ppp}"
		tfileTEquT=`ls -1 $datadir/${sps}/ocn/hist/${sps}_1d_*_*_grid_T_EquT.zip.nc`
		tfileTglobal=`ls -1 $datadir/${sps}/ocn/hist/${sps}_1d_*_*_grid_Tglobal.zip.nc`
		tfileT=`ls -1 $datadir/${sps}/ocn/hist/${sps}_1m_*_*_grid_T.zip.nc`
		tfileU=`ls -1 $datadir/${sps}/ocn/hist/${sps}_1m_*_*_grid_U.zip.nc`
		tfileV=`ls -1 $datadir/${sps}/ocn/hist/${sps}_1m_*_*_grid_V.zip.nc`

		case $var
 		 in
		 votemper)  tfile=$tfileTEquT ;;
		 sohtc040)  tfile=$tfileTglobal ;;
		 somixhgt)  tfile=$tfileT ;;
		 vozocrtx)  tfile=$tfileU ;;	
		 vomecrty)  tfile=$tfileV ;;	
		esac
		# declaring and final outputfile
		finalinputfile=${tfile}

		if [ $var = "votemper" ] ; then
			t=1
			for ff in $finalinputfile ; do

				ncks -O --mk_rec_dmn time_counter $ff ${sps}_1d_grid_T_EquT_m${t}.nc				
				t=$(($t + 1))

			done
			ncrcat -O ${sps}_1d_grid_T_EquT_m?.nc ${finaloutput}_tmp.nc
		else
			ncrcat -O -v $var ${finalinputfile} ${finaloutput}_tmp.nc
		fi
		case $var
		 in
		 somixhgt|vozocrtx|vomecrty)
					    cdo settaxis,$yy-$st-15,12:00:00,1mon ${finaloutput}_tmp.nc ${finaloutput}_tmp2.nc
		 			    cdo setreftime,$yy-$st-15,12:00:00 ${finaloutput}_tmp2.nc ${finaloutput}.nc  ;;
		 *)
					    cdo settaxis,$yy-$st-01,12:00:00,1day ${finaloutput}_tmp.nc ${finaloutput}_tmp2.nc
		 			    cdo setreftime,$yy-$st-01,12:00:00 ${finaloutput}_tmp2.nc ${finaloutput}.nc ;;
                esac
	
                rm ${finaloutput}_tmp*.nc
		mv ${finaloutput}.nc $datamm
	else
		continue	
	fi
	
done  #end loop on plist

touch $here/logs/capsule_${yy}${st}_oce_DONE
