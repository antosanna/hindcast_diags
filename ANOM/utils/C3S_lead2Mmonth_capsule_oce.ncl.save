begin

yyyy=getenv("yy")
st=getenv("st")
ppp=getenv("ppp")

ntime=0
month=toint(st)
year=toint(yyyy)
do nm=0,5

   if ( month .gt. 12 ) then
      month=1
      year=year+1
   end if
   year@calendar = "noleap"
   ndays=days_in_month(year,month)
   ntime=ntime+ndays	
   month=month+1

end do


filetype=getenv("filetype")
pathfile=getenv("datadir")

;************************************************
; variable and file handling
;************************************************

   diri = getenv("datadir")
   varm=getenv("var")
   flist="sps3.5_"+yyyy+st+"_"+ppp+"/ocn/hist/*"+yyyy+st+"_"+ppp+"_*"+filetype+".zip.nc"   ;getenv("flist")

   fili = systemfunc("cd "+diri+" ; ls "+flist)
   print(fili)
   nfils = dimsizes(fili) 

   fi = addfile (diri+"/"+fili(0), "r")
   varstd = fi->$varm$
   nn=dimsizes(varstd)
   rank=dimsizes(nn)

if ( rank .eq. 4 ) then
   deptht=fi->deptht(0:29)
end if  

if ( rank .eq. 4 ) then
   fall = addfiles (diri+"/"+fili, "r")
   varall=fall[:]->$varm$(:,0:29,:,:)
else if ( rank .eq. 3 ) then
   fall = addfiles (diri+"/"+fili, "r")
   varall=fall[:]->$varm$
end if
end if


filo=getenv("filo")   ;with full path
system("/bin/rm -f " + filo) 
fout  = addfile (filo, "c")  ; open output file

if ( rank .eq. 4 ) then
   dimNames = (/"time_counter", "nav_lat", "x", "deptht"/)  
   dimSizes = (/ -1   ,  nn(2),  nn(3), 30 /) 
   dimUnlim = (/ True , False, False, False/)   
   filedimdef(fout,dimNames,dimSizes,dimUnlim)
else
   dimNames = (/"time_counter", "nav_lat", "x"/)  
   dimSizes = (/ -1   ,  nn(1),  nn(2) /) 
   dimUnlim = (/ True , False, False/)   
   filedimdef(fout,dimNames,dimSizes,dimUnlim)

end if

filevardef(fout, "$varall$"  ,typeof(varall)  ,getvardims(varall)) 
filevarattdef(fout,"$varall$",varall)

if ( rank .eq. 4 ) then
   filevardef(fout, "deptht"    ,typeof(deptht)  ,getvardims(deptht)) 
   filevarattdef(fout,"deptht",deptht)
   fout->deptht = (/deptht/)
end if
fout->$varm$ = (/varall/)
;#######


end
